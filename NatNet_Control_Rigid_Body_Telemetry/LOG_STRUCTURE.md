# StampFly Hover Log Format

This document describes the CSV layout generated by `NatNet_Control_Rigid_Body_Telemetry/python_controller/hovering_controller.py`. These files are written to the `flight_logs/` directory with the pattern `log_YYYYMMDD_HHMMSS.csv` every time a hovering session is started.

## Coordinate Frames & Units

* Positions (`pos_*`, `raw_pos_*`, `rb_pos_*`) are expressed in metres after converting Motive coordinates (X, Y, Z) into the StampFly-centric `(drone_x, drone_y, drone_z)` frame (Z→X, X→Y, Y→Z).
* Angles in `_rad` columns are in radians; `_deg` columns are in degrees.
* Control loop timing (`loop_time_ms`, `feedback_latency_ms`, `feedback_age_ms`) is reported in milliseconds.
* Boolean flags are logged as `1` / `0` strings. Empty strings indicate values that were not available for that sample.

## Column Reference

### Session & Timing

| Column | Type | Description |
| ------ | ---- | ----------- |
| `timestamp` | ISO8601 string | Wall-clock time when the row was recorded. |
| `elapsed_time` | float (s) | Seconds since logging started. |
| `frame_number` | int | Latest NatNet frame index received. |
| `loop_time_ms` | float (ms) | Control-loop execution time for this iteration. |
| `command_sequence` | int (stringified) | Monotonic sequence attached to the outgoing angle command; blank when no command was sent. |
| `feedback_sequence` | int (stringified) | Sequence number echoed by StampFly in the most recent feedback packet; blank if no feedback yet. |
| `feedback_latency_ms` | float (ms) | Round-trip latency between command emit and feedback arrival. |
| `feedback_age_ms` | float (ms) | Time between the feedback packet timestamp and this log write (helps spot stale feedback). |

### Position & Error Metrics

| Column | Type | Units | Description |
| ------ | ---- | ----- | ----------- |
| `pos_x`, `pos_y`, `pos_z` | float | m | Filtered drone position used for control. |
| `raw_pos_x`, `raw_pos_y`, `raw_pos_z` | float | m | Unfiltered position sample passed to the filter (either rigid body or marker centroid). |
| `error_x`, `error_y` | float | m | Lateral position error relative to the origin target (`target_position`). |

### Commanded Attitude & PID Components

| Column | Type | Units | Description |
| ------ | ---- | ----- | ----------- |
| `roll_ref_rad`, `pitch_ref_rad` | float | rad | Commanded angles exported to the ESP32 relay. |
| `roll_ref_deg`, `pitch_ref_deg` | float | deg | Same references in degrees for readability. |
| `pid_x_p`, `pid_x_i`, `pid_x_d` | float | rad (equivalent) | Individual P/I/D contributions from the X-axis PID (roll). |
| `pid_y_p`, `pid_y_i`, `pid_y_d` | float | rad (equivalent) | Individual P/I/D contributions from the Y-axis PID (pitch). |
| `send_success` | 0/1 | – | Serial write acknowledgement (1 when the packet was written to the relay). |
| `control_active` | 0/1 | – | Indicates whether the outer-loop controller is currently applying corrections. |

### Feedback from StampFly

| Column | Type | Units | Description |
| ------ | ---- | ----- | ----------- |
| `feedback_roll_rad`, `feedback_pitch_rad` | float | rad | Applied angles reported back by StampFly via ESP-NOW. Empty if no feedback yet. |
| `feedback_match` | 0/1 | – | `1` when the latest feedback sequence matches the command sequence logged on the same row. |
| `feedback_delta_roll`, `feedback_delta_pitch` | float | rad | Difference between feedback and commanded angles (positive = StampFly > command). |

### Filter Health & Data Provenance

| Column | Type | Description |
| ------ | ---- | ----------- |
| `is_outlier` | 0/1 | Filter flagged the raw sample as an outlier. |
| `used_prediction` | 0/1 | Filter substituted a predicted position (rather than raw input). |
| `confidence` | float (0–1) | Filter confidence score used for command attenuation. |
| `consecutive_outliers` | int | Count of continuous outlier frames up to this sample. |
| `data_valid` | 0/1 | Whether the controller treated this sample as valid for PID update. |
| `data_source` | string | Data origin: `"rigid_body"`, `"markers"`, `"none"`, etc. |
| `filter_threshold` | float (m) | Dynamic distance threshold used for outlier detection (blank if unavailable). |
| `tracking_valid` | 0/1 | Raw Motive tracking_valid flag for the rigid body sample used. |

### Rigid-Body Diagnostics

| Column | Type | Units | Description |
| ------ | ---- | ----- | ----------- |
| `rb_error` | float | – | NatNet-reported rigid body solver error (smaller is better). |
| `rb_marker_count` | int | count | Number of markers contributing to the rigid body solve. |
| `rb_pos_x`, `rb_pos_y`, `rb_pos_z` | float | m | Latest rigid-body position in the drone frame (may be blank if Motive did not supply data). |
| `rb_qx`, `rb_qy`, `rb_qz`, `rb_qw` | float | – | Orientation quaternion from Motive. |
| `rb_roll_deg`, `rb_pitch_deg`, `rb_yaw_deg` | float | deg | Euler angles derived from the quaternion for quick inspection. |

## Usage Notes

* Rows are emitted at the controller rate (nominally 100 Hz). When OptiTrack data is missing the controller freezes commands, logs `send_success=0`, and records blanks for feedback metrics until telemetry resumes.
* Sequence numbers roll over at 2³². When the Python process restarts, `command_sequence` resets to zero.
* Feedback fields remain empty until the ESP32 relay receives a valid `CMD_FEEDBACK` packet from StampFly; the relay forwards these as binary `F` frames which the reader thread decodes.
* Additional metadata (e.g., Motive warnings) appears in the console but is not captured in the CSV; audit `flight_logs/` alongside terminal output for full context.

This reference should be sufficient to build visualisation and analytics tooling atop the generated flight logs.
